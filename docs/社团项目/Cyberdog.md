## 机器狗使用文档


### 1. 机器狗来源及所有权

在2023年8月，小米官方找到创新发明协会提出合作，具体合作提议是：创协对于新发行的Cyberdog2进行二次开发并录制视频进行宣传，以换取机器狗使用权。社团当时由于时任副会长莫栩承诺帮忙但并未完成相关工作等原因拖慢工作进度，导致未能完成既定任务。社团完成了机器狗的二次功能开发并录制了演示视频发送给小米，但是并没有完成最终宣传视频的拍摄和剪辑。因此，实际上社团并没有完全履行协议，机器狗的所有权也并未赠予社团。即：协会目前仅拥有机器狗的使用权，机器狗严格意义上并非社团财产，有可能被小米收回（但可能性不大）。


### 2. 机器狗介绍
机器狗型号为小米Cyberdog2，搭载系统为Ubuntu 20.04，基于ROS2开发。部分信息如下：

- [说明书](https://agreement.cyberdog.xiaomi.com/guide.html)
- [应用文档](https://miroboticslab.github.io/blogs/#/) 
- 主用户：mi <details><summary>密码：</summary>123</details>

除自带功能外，社团为机器狗开发了基于大语言模型的语音交互系统。

### 3. 机器狗项目使用
#### 3.1 刷机注意事项
由于机器狗系统不甚稳定，有时会出现无法开机等问题，因此有时需要进行刷机。刷机后，位于主存中的所有数据都会被清除，操作系统会被重置，但位于SD卡中的除音频等机器狗自带文件外的其他文件不会被清除。刷机注意事项如下：
- 具体操作见[刷机说明文档](https://miroboticslab.github.io/blogs/#/cn/cyberdog_flash)，刷机包在该文档评论区中可找到。
- 刷机包有多个版本，最新版本与社团自研的语音交互系统不兼容，无法播放用户自定义音频文件，但能够进行后空翻。若需要使用社团自研的语音交互系统，请使用旧版本的刷机包。
- 刷机需要使用Ubuntu系统。可以使用[社团Linux主机](../活动室/用电与网络.md#linux主机)

在刷机后，需要将默认主目录删除并将其软链接到存储在SD卡中的目录。软链接后在主目录中储存的信息也能够在下一次刷机后保留。具体大致操作为：
```bash
sudo rm -r /home/mi
sudo ln -s /SDCARD/mi /home/mi
```
具体操作需要根据实际情况进行调整，请勿直接复制粘贴以上命令。

#### 3.2 社团自研功能
##### 3.2.1 Cyberdog-GPT
Cyberdog-GPT是社团自研的基于大语言模型的语音交互系统，通过接入机器狗语音及动作控制接口，能够实现与机器狗的对话及简单的基于语音的动作控制。主要功能有：
- 强个性交互。目前使用的个性设计是玉玉症机器狗，极其悲观颓丧，黑色幽默风格。可以通过修改prompt文本文件实现个性更改。
- 自定义音色。目前使用的音色是东北老哥音色。可以通过修改代码内API调用的音色ID变量实现音色更改。
- 动作控制。可以通过语音控制机器狗做出简单的动作。

###### 语音功能
值得一提的是，Cyberdog2的官方API中并没有提供语音播放功能。小米官方只提供了2种接口：1) 指定ID播放预设音频文件；2) 调用小爱服务实现文字转语音。这两种功能都无法满足我们设计的功能需求，因此我使用了技术手段实现了自定义的语音播放。具体实现原理是：修改位于SD卡目录下的sounds文件夹中的音频文件及配置文件，增加自定义音频文件的ID，在调用在线TTS服务后将音频文件下载到预置音频目录中并修改其文件名使得其与配置文件中的配置信息对应，最后通过ROS2中的语音service实现播放。

###### 大语言模型
在2023年9月开发自研功能时，我将接入大预言API的工作交给了时任副会长莫栩。我向其提供了接入百度文心一言API的教程（基本上5分钟搞定并且有demo），其在修改demo中字符串变量后就直接向我交付工作，在我使用后发现效果不佳并要求使用ChatGPT后其以“改API调用好麻烦的”为由拒绝，导致我们原先使用百度文心一言实现交互。文心一言效果奇差无比。在2024年3月我们社团受邀参加樱花文化节时我花费了大约1小时成功接入了ChatGPT，效果十分理想。当时由于账号申请已经过了时限，无免费API额度，因此使用了国内一个[中转站](https://one.aiskt.com/)购买的API。目前已经过了半年，不确定API key是否仍能使用。

###### TTS
该项目使用火山引擎的TTS API。目前token已过期，需重新购买。

###### 个性设计
为了方便更改与迁移，我将prompt模板放在了文本文件中。


##### 3.2.2 命令行控制系统
为方便在电脑控制机器狗，我开发了一套基于命令行的控制系统。该系统的功能有：
- 使用键盘控制机器狗移动及动作
- 使用键盘控制机器狗播放对应预置音频文件

###### 音频文件
如前文所说，机器狗只能播放预置音频文件，且在刷机后机器狗系统相关文件会被重置，因此在刷机后此功能需要重新进行配置。具体操作是：
1. 查看代码中各个音频对应的ID
2. 使用TTS服务将生成对应的opus格式音频文件。此部信息未保留在项目中，需要重新手动实现。
3. 将音频文件命名后放入预置音频目录中，修改配置文件。


